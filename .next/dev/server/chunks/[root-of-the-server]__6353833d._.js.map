{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 15, "column": 0}, "map": {"version":3,"sources":["file:///D:/Akshat%20Singh/SideProjIdeas/Desi-Ngl/db.js"],"sourcesContent":["const mongoose = require(\"mongoose\");\nrequire('dotenv').config()\n\nconst Schema = mongoose.Schema;\nconst ObjectId = Schema.ObjectId;\n\nif (mongoose.connection.readyState === 0) {\n    if (process.env.DATABASE) {\n        mongoose.connect(process.env.DATABASE)\n            .then(() => console.log(\"Connected to DB\"))\n            .catch(err => console.error(\"DB Config Error:\", err));\n    } else {\n        console.warn(\"No DATABASE environment variable found.\");\n    }\n}\n\nconst userSchema = new Schema({\n    username: String,\n    createdAt: { type: Date, default: Date.now }\n})\nconst replySchema = new Schema({\n    reply: String,\n    repliedBy: String, // username of the person replying\n    repliedAt: { type: Date, default: Date.now }\n})\n\nconst messageSchema = new Schema({\n    message: String,\n    mood: { type: String, default: 'Serious' },\n    userId: ObjectId,\n    // Unique token for sender to view their message and replies\n    senderToken: { type: String, unique: true, sparse: true },\n    // Dynamic reactions - can accept any emoji as key\n    reactions: { type: Schema.Types.Mixed, default: {} },\n    // Replies from the message receiver\n    replies: [replySchema],\n    // Optional sender metadata if they choose to share hints\n    senderMeta: {\n        share: { type: Boolean, default: false },\n        ip: { type: String, default: null },\n        deviceType: { type: String, default: null },\n        os: { type: String, default: null },\n        userAgent: { type: String, default: null }\n    },\n    createdAt: { type: Date, default: Date.now }\n})\n\n// Prevent model overwrite error in dev mode\nif (mongoose.models.users) delete mongoose.models.users\nif (mongoose.models.messages) delete mongoose.models.messages\n\nconst userModal = mongoose.model(\"users\", userSchema);\nconst messageModal = mongoose.model(\"messages\", messageSchema);\n\nmodule.exports = {\n    userModal,\n    messageModal\n}\n"],"names":[],"mappings":"AAAA,MAAM;AACN,+GAAkB,MAAM;AAExB,MAAM,SAAS,SAAS,MAAM;AAC9B,MAAM,WAAW,OAAO,QAAQ;AAEhC,IAAI,SAAS,UAAU,CAAC,UAAU,KAAK,GAAG;IACtC,IAAI,QAAQ,GAAG,CAAC,QAAQ,EAAE;QACtB,SAAS,OAAO,CAAC,QAAQ,GAAG,CAAC,QAAQ,EAChC,IAAI,CAAC,IAAM,QAAQ,GAAG,CAAC,oBACvB,KAAK,CAAC,CAAA,MAAO,QAAQ,KAAK,CAAC,oBAAoB;IACxD,OAAO;QACH,QAAQ,IAAI,CAAC;IACjB;AACJ;AAEA,MAAM,aAAa,IAAI,OAAO;IAC1B,UAAU;IACV,WAAW;QAAE,MAAM;QAAM,SAAS,KAAK,GAAG;IAAC;AAC/C;AACA,MAAM,cAAc,IAAI,OAAO;IAC3B,OAAO;IACP,WAAW;IACX,WAAW;QAAE,MAAM;QAAM,SAAS,KAAK,GAAG;IAAC;AAC/C;AAEA,MAAM,gBAAgB,IAAI,OAAO;IAC7B,SAAS;IACT,MAAM;QAAE,MAAM;QAAQ,SAAS;IAAU;IACzC,QAAQ;IACR,4DAA4D;IAC5D,aAAa;QAAE,MAAM;QAAQ,QAAQ;QAAM,QAAQ;IAAK;IACxD,kDAAkD;IAClD,WAAW;QAAE,MAAM,OAAO,KAAK,CAAC,KAAK;QAAE,SAAS,CAAC;IAAE;IACnD,oCAAoC;IACpC,SAAS;QAAC;KAAY;IACtB,yDAAyD;IACzD,YAAY;QACR,OAAO;YAAE,MAAM;YAAS,SAAS;QAAM;QACvC,IAAI;YAAE,MAAM;YAAQ,SAAS;QAAK;QAClC,YAAY;YAAE,MAAM;YAAQ,SAAS;QAAK;QAC1C,IAAI;YAAE,MAAM;YAAQ,SAAS;QAAK;QAClC,WAAW;YAAE,MAAM;YAAQ,SAAS;QAAK;IAC7C;IACA,WAAW;QAAE,MAAM;QAAM,SAAS,KAAK,GAAG;IAAC;AAC/C;AAEA,4CAA4C;AAC5C,IAAI,SAAS,MAAM,CAAC,KAAK,EAAE,OAAO,SAAS,MAAM,CAAC,KAAK;AACvD,IAAI,SAAS,MAAM,CAAC,QAAQ,EAAE,OAAO,SAAS,MAAM,CAAC,QAAQ;AAE7D,MAAM,YAAY,SAAS,KAAK,CAAC,SAAS;AAC1C,MAAM,eAAe,SAAS,KAAK,CAAC,YAAY;AAEhD,OAAO,OAAO,GAAG;IACb;IACA;AACJ"}},
    {"offset": {"line": 104, "column": 0}, "map": {"version":3,"sources":["file:///D:/Akshat%20Singh/SideProjIdeas/Desi-Ngl/pages/api/admin/stats.js"],"sourcesContent":["import { userModal, messageModal } from '../../../db'\r\n\r\nexport default async function handler(req, res) {\r\n  // Simple auth check - in production, use proper JWT/session\r\n  const authHeader = req.headers.authorization\r\n  if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n    return res.status(401).json({ error: 'Unauthorized' })\r\n  }\r\n\r\n  try {\r\n    // Get all statistics\r\n    const totalUsers = await userModal.countDocuments()\r\n    const totalMessages = await messageModal.countDocuments()\r\n    \r\n    // Messages with replies\r\n    const messagesWithReplies = await messageModal.countDocuments({\r\n      'replies.0': { $exists: true }\r\n    })\r\n    \r\n    // Total replies\r\n    const allMessages = await messageModal.find({}).select('replies').lean()\r\n    const totalReplies = allMessages.reduce((sum, msg) => {\r\n      return sum + (msg.replies?.length || 0)\r\n    }, 0)\r\n\r\n    // Messages by mood\r\n    const messagesByMood = await messageModal.aggregate([\r\n      {\r\n        $group: {\r\n          _id: '$mood',\r\n          count: { $sum: 1 }\r\n        }\r\n      },\r\n      { $sort: { count: -1 } }\r\n    ])\r\n\r\n    // Messages in last 7 days\r\n    const sevenDaysAgo = new Date()\r\n    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7)\r\n    const messagesLast7Days = await messageModal.countDocuments({\r\n      createdAt: { $gte: sevenDaysAgo }\r\n    })\r\n\r\n    // Messages in last 30 days\r\n    const thirtyDaysAgo = new Date()\r\n    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)\r\n    const messagesLast30Days = await messageModal.countDocuments({\r\n      createdAt: { $gte: thirtyDaysAgo }\r\n    })\r\n\r\n    // Users created in last 7 days\r\n    const usersLast7Days = await userModal.countDocuments({\r\n      createdAt: { $gte: sevenDaysAgo }\r\n    })\r\n\r\n    // Users created in last 30 days\r\n    const usersLast30Days = await userModal.countDocuments({\r\n      createdAt: { $gte: thirtyDaysAgo }\r\n    })\r\n\r\n    // Messages per day (last 7 days)\r\n    const messagesPerDay = []\r\n    for (let i = 6; i >= 0; i--) {\r\n      const date = new Date()\r\n      date.setDate(date.getDate() - i)\r\n      date.setHours(0, 0, 0, 0)\r\n      const nextDate = new Date(date)\r\n      nextDate.setDate(nextDate.getDate() + 1)\r\n      \r\n      const count = await messageModal.countDocuments({\r\n        createdAt: { $gte: date, $lt: nextDate }\r\n      })\r\n      \r\n      messagesPerDay.push({\r\n        date: date.toISOString().split('T')[0],\r\n        count\r\n      })\r\n    }\r\n\r\n    // Most active users (by message count)\r\n    const mostActiveUsers = await messageModal.aggregate([\r\n      {\r\n        $group: {\r\n          _id: '$userId',\r\n          messageCount: { $sum: 1 }\r\n        }\r\n      },\r\n      { $sort: { messageCount: -1 } },\r\n      { $limit: 10 }\r\n    ])\r\n\r\n    // Get usernames for most active users\r\n    const userIds = mostActiveUsers.map(u => u._id)\r\n    const users = await userModal.find({ _id: { $in: userIds } }).select('username').lean()\r\n    const userMap = {}\r\n    users.forEach(u => {\r\n      userMap[u._id.toString()] = u.username\r\n    })\r\n\r\n    const activeUsersWithNames = mostActiveUsers.map(u => ({\r\n      userId: u._id,\r\n      username: userMap[u._id.toString()] || 'Unknown',\r\n      messageCount: u.messageCount\r\n    }))\r\n\r\n    // Messages with reactions\r\n    const messagesWithReactions = await messageModal.countDocuments({\r\n      $or: [\r\n        { 'reactions': { $exists: true, $ne: {} } },\r\n        { 'reactions.ðŸ”¥': { $exists: true, $ne: [] } },\r\n        { 'reactions.â¤ï¸': { $exists: true, $ne: [] } },\r\n        { 'reactions.ðŸ˜‚': { $exists: true, $ne: [] } }\r\n      ]\r\n    })\r\n\r\n    // Average messages per user\r\n    const avgMessagesPerUser = totalUsers > 0 ? (totalMessages / totalUsers).toFixed(2) : 0\r\n\r\n    // Average replies per message\r\n    const avgRepliesPerMessage = totalMessages > 0 ? (totalReplies / totalMessages).toFixed(2) : 0\r\n\r\n    return res.status(200).json({\r\n      success: true,\r\n      stats: {\r\n        overview: {\r\n          totalUsers,\r\n          totalMessages,\r\n          totalReplies,\r\n          messagesWithReplies,\r\n          messagesWithReactions,\r\n          avgMessagesPerUser: parseFloat(avgMessagesPerUser),\r\n          avgRepliesPerMessage: parseFloat(avgRepliesPerMessage)\r\n        },\r\n        growth: {\r\n          messagesLast7Days,\r\n          messagesLast30Days,\r\n          usersLast7Days,\r\n          usersLast30Days\r\n        },\r\n        messagesByMood,\r\n        messagesPerDay,\r\n        mostActiveUsers: activeUsersWithNames\r\n      }\r\n    })\r\n  } catch (error) {\r\n    console.error('Stats error:', error)\r\n    return res.status(500).json({ error: 'Failed to fetch statistics' })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}